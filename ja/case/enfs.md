## 1. eNFS概要

eNFSはNFSクライアントの拡張機能で、NFSマルチパス、負荷分散、フェイルオーバーをサポートします。
詳細については以下を参照してください：
- https://docs.openeuler.org/zh/docs/20.03_LTS_SP4/docs/eNFS/enfs使用指南.html
- [オペレーティングシステム技術白書イノベーションプロジェクト概要](https://www.openeuler.org/whitepaper/openEuler操作系统（创新项目总览）.pdf)

## 2. PXVIRTでeNFSを有効にする

### 2.1 一般的なeNFSアーキテクチャ

PXVIRTホストには2つのIPがあります。例：10.13.13.1、10.13.14.1

NFSサーバーには2つのIPがあります。例：10.13.13.254、10.13.14.254

```
┌─────────────────────┐                    ┌─────────────────────┐
│    PXVIRTホスト      │                    │    NFSサーバー       │
│                     │                    │                     │
│  ┌─────────────┐    │                    │  ┌─────────────┐    │
│  │ eNFSクライアント │    │                    │  │ NFSサーバー  │    │
│  └─────────────┘    │                    │  └─────────────┘    │
│         │           │                    │         │           │
│    ┌────┴────┐      │                    │    ┌────┴────┐      │
│    │10.13.13.1│ ────┼──────────────────────────→│10.13.13.254│ │
│    └─────────┘      │  接続パス1           │     └─────────┘      │
│                     │                    │                     │
│    ┌─────────┐      │                    │    ┌─────────┐      │
│    │10.13.14.1│ ────┼──────────────────────────→│10.13.14.254│ │
│    └─────────┘      │  接続パス2           │    └─────────┘      │
│                     │                    │                     │
└─────────────────────┘                    └─────────────────────┘
```

PXVIRTクラスターでeNFSを有効にすることができます。これにより、PXVIRTホストは10.13.13.254と10.13.14.254に同時に接続し、負荷分散とマルチパスが有効になります。

### 2.2 PXVIRTでeNFSを有効にする

#### 2.2.1 システム要件

    1. カーネル`6.6-openeuler`、バージョン >= `6.6.0-10`が必要
    2. NFSサーバーはv3サポートを有効にする必要があります。eNFSはv3のみをサポートします。

eNFSはクライアント側の拡張機能であり、NFSサーバーとは関係ないため、カーネル要件が満たされている限り、異なるPXVIRTおよびPVEバージョンもサポートされます。

#### 2.2.2 各ノードでeNFS設定ファイルを作成（任意）

```
cat /etc/enfs/config.ini
# マルチパスを有効にする
multipath_disable=0
```

#### 2.2.3 クラスターNFSサービスの作成

`/etc/pve/storage.cfg`を編集
```
nfs: nfs
        export /NFS/vm
        path /mnt/pve/nfs
        server 10.13.14.3
        content images
        options remoteaddrs=10.13.14.3~10.13.13.3,vers=3
        prune-backups keep-all=1
```

WebUIで直接NFSストレージを作成し、vers=3を選択してから、`/etc/pve/storage.cfg`にoptionsを追加することもできます。これにより、PXVIRTホスト上のeNFSモジュールが有効になり、ローカルIPを検索して2つのNFSサーバー10.13.14.3と10.13.13.3に接続します。

#### 2.2.4 検証

`mount`を入力して現在の状態を確認します。eNFSとremoteaddrsが表示されます：
```
....
10.13.14.3:/NFS/vm on /mnt/pve/nfs type nfs 
(rw,relatime,vers=3,rsize=1048576,wsize=1048576,namlen=255,hard,
proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=10.13.14.3,
mountvers=3,mountport=36277,mountproto=udp,
local_lock=none,addr=10.13.14.3,remoteaddrs=10.13.14.3~10.13.13.
3,slookupcache=all,alookupcache=all,enfs_info=10.13.14.3_1)
...
```

procでeNFSの状況を確認できます。パスは `/proc/enfs/<nfsserver>/stat` です：
```
root@pxvirt-test1:~# cat  /proc/enfs/*/stat 
id    local_addr     remote_addr    r_count               r_rtt                 r_exec                w_count               w_rtt                 w_exec                queuelen              
0     10.13.14.81    10.13.14.3     0                     0                     0                     499                   7                     24                    0                     
1     10.13.13.81    10.13.13.3     0                     0                     0                     525                   6                     26                    0                     
root@pxvirt-test1:~# 
```

## 3. eNFS設定リファレンス

### 3.1 設定ファイル形式
- `#`で始まる行はコメント
- `key=value`形式の設定項目
- 空行は無視される
- 設定項目は大文字小文字を区別しない
- 動的ホットリロードをサポート（一部の設定項目）

### 3.2 詳細設定パラメータの説明

#### 1. path_detect_interval - パス検出間隔

**機能**：
- ENFSのマルチパスネットワーク接続の健康状態検出頻度を制御
- システムは定期的にプローブパケットを送信して各パスの可用性をチェック
- 障害検出と自動切り替えの実現に使用

**デフォルト値**：10秒  
**範囲**：5-300秒

**使用場面**：
- **高可用性環境**：小さな値（5-10秒）を設定して迅速な障害検出を実現
- **安定したネットワーク**：大きな値（60-120秒）を設定してネットワークオーバーヘッドを削減
- **帯域幅制限**：間隔を増加してプローブトラフィックを削減

**設定例**：
```ini
# 高可用性シナリオ - 迅速な障害検出
path_detect_interval=5

# 一般的なシナリオ - パフォーマンスとオーバーヘッドのバランス
path_detect_interval=10

# 安定したネットワーク - プローブオーバーヘッドを削減
path_detect_interval=60
```

#### 2. path_detect_timeout - パス検出タイムアウト

**機能**：
- 単一パスプローブのタイムアウト時間を設定
- この時間内に応答が受信されない場合、パスは障害と見なされる
- 障害検出の感度に影響

**デフォルト値**：5秒  
**範囲**：1-60秒

**使用場面**：
- **高速ネットワーク**：小さな値（1-3秒）を設定して迅速な障害発見
- **低速ネットワーク**：大きな値（10-20秒）を設定して誤判定を回避
- **WAN接続**：適切にタイムアウトを増加

**設定例**：
```ini
# 高速LAN環境
path_detect_timeout=2

# 標準企業ネットワーク
path_detect_timeout=5

# WANまたは衛星リンク
path_detect_timeout=15
```

#### 3. multipath_timeout - マルチパスタイムアウト

**機能**：
- マルチパス操作の全体タイムアウト時間を制御
- すべてのパスが応答しない場合の最大待機時間
- 0はmountコマンドで指定されたタイムアウトパラメータを使用することを意味

**デフォルト値**：0（mountパラメータを使用）  
**範囲**：0-60秒

**使用場面**：
- **厳格なSLA**：固定タイムアウトを設定して応答時間を保証
- **耐障害性優先**：大きな値を設定してより多くの再試行を許可
- **デフォルト動作**：0を設定してmountコマンドパラメータを使用

**設定例**：
```ini
# mountコマンドのtimeoパラメータを使用
multipath_timeout=0

# 金融取引システム - 厳格なタイムアウト制御
multipath_timeout=10

# バッチ処理システム - より長い待機を許可
multipath_timeout=30
```

#### 4. multipath_disable - マルチパス機能スイッチ

**機能**：
- ENFSマルチパス機能をグローバルに有効化または無効化
- 無効化された場合、ENFSは標準のNFS動作に退化
- 障害診断または互換性問題のトラブルシューティングに使用

**デフォルト値**：0（有効）  
**範囲**：0-1

**使用場面**：
- **本番環境**：0を設定してマルチパスを有効化し高可用性を獲得
- **トラブルシューティング**：一時的に1を設定してネットワーク問題をトラブルシュート
- **互換性テスト**：シングルパス下でのアプリケーション動作を検証

**設定例**：
```ini
# 本番環境 - マルチパスを有効
multipath_disable=0

# トラブルシューティング - 一時的にマルチパスを無効
multipath_disable=1
```

#### 5. multipath_select_policy - マルチパス選択ポリシー

**機能**：
- 複数の利用可能なパス間で送信パスを選択する方法を制御
- 負荷分散効果とパフォーマンス分布に影響
- 異なるビジネスシナリオ要件をサポート

**デフォルト値**：roundrobin  
**利用可能な値**：
- `roundrobin`：ラウンドロビンモード、リクエストを均等に配分
- `shardview`：シャードビューモード、データシャーディングに基づいてパスを選択

**使用場面**：
- **一般的なシナリオ**：roundrobinは大部分のアプリケーションに適している
- **大きなファイル転送**：shardviewはより良いパフォーマンスを提供する可能性
- **特定の最適化**：ストレージシステムの特性に基づいて選択

**設定例**：
```ini
# 標準負荷分散
multipath_select_policy=roundrobin

# シャード化ストレージ用に最適化
multipath_select_policy=shardview
```

#### 6. dns_update_interval - DNS更新間隔

**機能**：
- DNS解決結果の更新頻度を制御
- 新しいサーバーIPアドレスの動的発見に使用
- クラウド環境での弾性スケーリングをサポート

**デフォルト値**：5分  
**範囲**：0-2147483647分

**使用場面**：
- **クラウド環境**：短い間隔（1-5分）でIP変更への迅速な適応
- **静的環境**：長い間隔（60-120分）でDNSクエリを削減
- **更新を無効化**：0を設定して自動DNS更新を無効化

**設定例**：
```ini
# クラウドネイティブ環境 - 頻繁な更新
dns_update_interval=1

# 標準企業環境
dns_update_interval=5

# 静的IP環境 - DNSクエリを削減
dns_update_interval=60

# 自動DNS更新を無効化
dns_update_interval=0
```

#### 7. dns_auto_multipath_resolution - DNS自動マルチパス解決

**機能**：
- 単一のDNS名を複数のIPアドレスに自動的に解決
- DNSラウンドロビンに基づいてマルチパスを自動作成
- 手動IPの指定なしでマルチパス設定を簡素化

**デフォルト値**：0（無効）  
**範囲**：0-1

**使用場面**：
- **設定の簡素化**：手動設定なしで自動マルチパス発見を有効化
- **クラウド環境**：ロードバランサーを使用するシナリオに適している
- **従来の設定**：無効化して手動指定のIPリストを使用

**設定例**：
```ini
# 自動マルチパス発見を有効化
dns_auto_multipath_resolution=1

# 手動設定のIPリストを使用
dns_auto_multipath_resolution=0
```

**実際の使用例**：
```bash
# 自動解決が有効な場合、単一のホスト名が複数のIPに解決される
# 例：nfs.example.com -> 192.168.1.10, 192.168.1.11, 192.168.1.12
mount -t nfs nfs.example.com:/data /mnt/data

# 無効な場合、手動でマルチパスを指定する必要がある
mount -t nfs -o remoteaddrs=192.168.1.10,192.168.1.11 server:/data /mnt/data
```

#### 8. shardview_update_interval - シャードビュー更新間隔

**機能**：
- ストレージシャード情報の更新頻度を制御
- 分散ストレージシステムのメタデータ同期に使用
- データ一貫性とパフォーマンス最適化に影響

**デフォルト値**：60秒  
**範囲**：30-300秒

**使用場面**：
- **頻繁な変更**：シャードが頻繁に調整される場合は短い間隔を使用
- **安定したシステム**：シャードレイアウトが安定している場合は長い間隔を使用
- **パフォーマンス最適化**：メタデータ更新オーバーヘッドに基づいて調整

**設定例**：
```ini
# 動的シャーディング環境
shardview_update_interval=30

# 標準設定
shardview_update_interval=60

# 安定した環境 - メタデータクエリを削減
shardview_update_interval=180
```

#### 9. priopity_array_wwns - 優先度WWN配列

**機能**：
- ストレージデバイスの優先順序を設定
- WWN（World Wide Name）はストレージデバイスの一意識別子
- リスト内のストレージデバイスをデータ転送に優先的に使用

**形式**：カンマ区切りのWWNリスト  
**最大数**：6個

**使用場面**：
- **ストレージ階層化**：高性能ストレージデバイスを優先
- **近接アクセス**：ローカルまたは近距離ストレージを優先
- **コスト制御**：低コストストレージを優先

**設定例**：
```ini
# 高性能SSDストレージを優先
priopity_array_wwns=21:00:00:24:ff:7f:4a:01,21:00:00:24:ff:7f:4a:02

# マルチストレージ階層化戦略
priopity_array_wwns=ssd001,ssd002,sas003,sata004
```

#### 10. local_ip_filters - ローカルIPフィルター

**機能**：
- ENFSが使用するローカルネットワークインターフェースを制限
- IPアドレス範囲によりアウトバウンドネットワークトラフィックを制御
- ネットワーク分離とセキュリティポリシーを実装

**形式**：カンマ区切りのIPアドレスまたはネットワークセグメント  
**最大数**：8個

**使用場面**：
- **ネットワーク分離**：特定のネットワークセグメントインターフェースの使用を制限
- **パフォーマンス最適化**：高帯域幅ネットワークインターフェースのみを使用
- **セキュリティポリシー**：安全でないネットワークを通じた送信を回避

**設定例**：
```ini
# 高速内部ネットワークのみを使用
local_ip_filters=192.168.1.0/24,10.0.0.0/8

# マルチNIC環境 - 専用ストレージネットワークを指定
local_ip_filters=172.16.0.0/16,172.17.0.0/16

# 管理ネットワークを除外 - ビジネスネットワークのみを使用
local_ip_filters=10.1.0.0/16,10.2.0.0/16
```

#### 11. lookupcache_interval - ルックアップキャッシュ間隔

**機能**：
- ファイル/ディレクトリルックアップ結果のキャッシュ時間を制御
- 冗長なネットワークルックアップリクエストを削減
- パフォーマンスとデータ一貫性のバランス

**デフォルト値**：60秒  
**範囲**：30秒 - 2147483647秒

**使用場面**：
- **頻繁なアクセス**：データの新鮮さを保証するため短いキャッシュ時間
- **安定したディレクトリ**：パフォーマンス向上のため長いキャッシュ時間
- **リアルタイム要件**：ビジネスニーズに基づいて調整

**設定例**：
```ini
# 高リアルタイム要件
lookupcache_interval=30

# 標準設定
lookupcache_interval=60

# 静的ファイルシステム - 長期キャッシュ
lookupcache_interval=3600
```

#### 12. lookupcache_enable - ルックアップキャッシュ有効化

**機能**：
- ルックアップキャッシュ機能をグローバルに有効化または無効化
- ディレクトリとファイルメタデータのキャッシュ動作に影響
- パフォーマンスチューニングまたはトラブルシューティングに使用

**デフォルト値**：1（有効）  
**範囲**：0-1

**使用場面**：
- **パフォーマンス最適化**：キャッシュを有効にしてネットワークオーバーヘッドを削減
- **リアルタイム要件**：キャッシュを無効にして最新データを保証
- **デバッグ問題**：キャッシュ関連問題のトラブルシューティングのため一時的に無効化

**設定例**：
```ini
# キャッシュを有効にしてパフォーマンスを向上
lookupcache_enable=1

# キャッシュを無効にしてリアルタイムデータを保証
lookupcache_enable=0
```

#### 13. link_count_per_mount - マウントポイントあたりのリンク数

**機能**：
- 単一NFSマウントポイントが使用できる最大ネットワーク接続数を制限
- 個別マウントポイントのリソース消費を制御
- 単一マウントポイントがシステムリソースを過度に消費することを防止

**デフォルト値**：32  
**範囲**：2-1024

**使用場面**：
- **高並行性**：並行パフォーマンス向上のため接続数を増加
- **リソース制限**：システムリソース節約のため接続数を削減
- **負荷分散**：サーバー能力に基づいて調整

**設定例**：
```ini
# 高性能サーバー
link_count_per_mount=128

# 標準設定
link_count_per_mount=32

# リソース制限環境
link_count_per_mount=8
```

#### 14. link_count_total - システム総リンク数

**機能**：
- システム全体の最大ネットワーク接続総数を制限
- 過度な接続によるシステムリソース枯渇を防止
- システムレベルのリソース保護

**デフォルト値**：512  
**範囲**：512-16384

**使用場面**：
- **大規模システム**：より多くのマウントポイントをサポートするため総接続数を増加
- **組み込みシステム**：ハードウェア制限に適応するため接続数を削減
- **クラウド環境**：インスタンス仕様に基づいて調整

**設定例**：
```ini
# 大型サーバー
link_count_total=8192

# 標準サーバー
link_count_total=512

# エッジデバイス
link_count_total=256
```

#### 15. native_link_io_enable - ネイティブリンクIO有効化

**機能**：
- ネイティブネットワークIO最適化を有効化または無効化
- 基礎となるネットワーク転送の実装方式に影響
- より良いパフォーマンスまたは互換性を提供する可能性

**デフォルト値**：1（有効）  
**範囲**：0-1

**使用場面**：
- **パフォーマンス最適化**：より良いIOパフォーマンスを得るため有効化
- **互換性問題**：特定のネットワークデバイス互換性を解決するため無効化
- **デバッグ分析**：パフォーマンス比較のため異なる実装を切り替え

**設定例**：
```ini
# ネイティブIO最適化を有効化
native_link_io_enable=1

# 互換性モード
native_link_io_enable=0
```

#### 16. create_path_no_route - ルートなしパス作成

**機能**：
- ネットワークルートがない場合でも接続作成を試行するかを制御
- 不完全なネットワーク設定シナリオの処理に使用
- 接続確立の耐障害性動作に影響

**デフォルト値**：0（無効）  
**範囲**：0-1

**使用場面**：
- **動的ルーティング**：動的ルート変更を処理するため有効化
- **静的設定**：無効な接続試行を避けるため無効化
- **ネットワーク障害回復**：ネットワーク自己修復をサポートするため有効化

**設定例**：
```ini
# 動的ネットワーク環境
create_path_no_route=1

# 静的ネットワーク設定
create_path_no_route=0
```

### 3.3 完全な設定例

#### 3.3.1 高性能本番環境設定
```ini
# ENFS高性能本番環境設定
# 高帯域幅、低遅延の企業ネットワーク環境に適用

# パス検出 - 迅速な障害発見
path_detect_interval=10
path_detect_timeout=3

# マルチパス設定 - すべての機能を有効化
multipath_disable=0
multipath_timeout=15
multipath_select_policy=roundrobin

# DNS設定 - 動的環境をサポート
dns_update_interval=5
dns_auto_multipath_resolution=1

# シャードビュー - 標準更新間隔
shardview_update_interval=60

# キャッシュ設定 - パフォーマンスと一貫性のバランス
lookupcache_enable=1
lookupcache_interval=60

# 接続数設定 - 高並行性サポート
link_count_per_mount=64
link_count_total=2048

# パフォーマンス最適化
native_link_io_enable=1
create_path_no_route=0

# ネットワーク設定 - 高速ストレージネットワークを使用
local_ip_filters=10.1.0.0/16,10.2.0.0/16

# ストレージ優先度 - SSD使用を優先
priopity_array_wwns=ssd001,ssd002,ssd003
```

#### 3.3.2 クラウド環境設定
```ini
# ENFSクラウド環境設定
# 弾性スケーリングクラウドコンピューティング環境に適用

# パス検出 - クラウドネットワーク特性に適応
path_detect_interval=15
path_detect_timeout=5

# マルチパス設定
multipath_disable=0
multipath_timeout=0
multipath_select_policy=roundrobin

# DNS設定 - 弾性IP適応のための頻繁な更新
dns_update_interval=2
dns_auto_multipath_resolution=1

# シャードビュー - 動的スケーリング適応のための短い間隔
shardview_update_interval=45

# キャッシュ設定 - 動的変更適応のための短いキャッシュ
lookupcache_enable=1
lookupcache_interval=30

# 接続数設定 - 中規模
link_count_per_mount=32
link_count_total=1024

# クラウド環境最適化
native_link_io_enable=1
create_path_no_route=1
```

#### 3.3.3 エッジコンピューティング設定
```ini
# ENFSエッジコンピューティング設定
# リソース制限のあるエッジデバイスに適用

# パス検出 - リソース節約のための長い間隔
path_detect_interval=30
path_detect_timeout=10

# マルチパス設定 - 基本機能
multipath_disable=0
multipath_timeout=20
multipath_select_policy=roundrobin

# DNS設定 - DNSクエリを削減
dns_update_interval=30
dns_auto_multipath_resolution=0

# シャードビュー - リソース節約のための長い間隔
shardview_update_interval=120

# キャッシュ設定 - ネットワークリクエスト削減のための長期キャッシュ
lookupcache_enable=1
lookupcache_interval=300

# 接続数設定 - リソース消費を制限
link_count_per_mount=8
link_count_total=128

# リソース節約設定
native_link_io_enable=1
create_path_no_route=0
```

#### 3.3.4 パフォーマンスチューニング推奨事項

#### 3.3.5 高IOPSシナリオ
- `path_detect_interval`と`path_detect_timeout`を削減
- `link_count_per_mount`を増加
- `native_link_io_enable`を有効化
- `roundrobin`負荷分散戦略を使用

#### 3.3.6 大きなファイル転送シナリオ
- `multipath_timeout`を適切に増加
- `shardview`戦略の使用を検討
- 総接続数`link_count_total`を増加
- 専用ストレージネットワークを使用（`local_ip_filters`を設定）

#### 3.3.7 WANシナリオ
- 各種タイムアウトパラメータを増加
- 長期キャッシュを有効化
- DNS更新頻度を削減
- ネットワーク変動を処理するため`create_path_no_route`を有効化

### 3.4 トラブルシューティング

#### 3.4.1 一般的な問題と設定調整
1. **頻繁な接続切断**：`path_detect_timeout`を増加
2. **パフォーマンス不良**：`link_count_per_mount`設定を確認
3. **DNS解決問題**：`dns_update_interval`を調整または`dns_auto_multipath_resolution`を無効化
4. **キャッシュ一貫性問題**：`lookupcache_interval`を削減またはキャッシュを無効化

#### 3.4.2 デバッグ設定
```ini
# トラブルシューティング設定 - 分析のため最適化機能を無効化
multipath_disable=1
lookupcache_enable=0
dns_auto_multipath_resolution=0
native_link_io_enable=0
```

これらのパラメータを適切に設定することにより、ENFSは異なるネットワーク環境とアプリケーションシナリオで最適なパフォーマンスを実現できます。